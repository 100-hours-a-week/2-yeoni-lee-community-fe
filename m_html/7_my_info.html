<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì›ì •ë³´ ìˆ˜ì •</title>
    <link rel="stylesheet" href="7_my_info.css">
</head>
<body>
    <section class="wrap">
        <h1 class="name" id="header-title">ì•„ë¬´ ë§ ëŒ€ì”ì¹˜</h1>
        <hr class="horizontal-rule"/>
        <h1 class="page_title">ë‚´ ì •ë³´ ë³´ê¸°</h1>
        <div class="dropdown">
            <button class="dropbtn"> 
                <img id="dropdown-profile-pic" class="dropbtn_icon" alt="í”„ë¡œí•„ ì‚¬ì§„" src="default-profile.jpg" />
            </button>
            <div class="dropdown-content">
                <button class="menu" id="mod_my_btn">íšŒì›ì •ë³´ ìˆ˜ì •</button>
                <button class="menu" id="mod_pw_btn">ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì •</button>
                <button class="menu" id="log_out_btn">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <!-- í”„ë¡œí•„ ì •ë³´ -->
        <article class="profile">
            <p class="description">í”„ë¡œí•„ ì‚¬ì§„*</p>
            <div class="profile-pic-container" id="profile-pic-container">
                <input type="file" id="profile-pic-input" accept="image/*" style="display: none;">
                <div class="profile-pic" id="profile-pic"></div>
                <p id="profile-pic-filename">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</p>
            </div>            
            <p class="description">ì´ë©”ì¼</p>
            <p class="email" id="user-email">ì´ë©”ì¼ ë¡œë“œ ì¤‘...</p>
            <p class="description">ë‹‰ë„¤ì„</p>
            <input type="text" id="nickname" class="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
            <small class="helper-text" id="helper-text"></small>
        </article>

        <!-- ë²„íŠ¼ ì˜ì—­ -->
        <div class="buttons">
            <button class="button edit" id="update-btn">ìˆ˜ì •í•˜ê¸°</button>
            <button class="button delete" id="delete-btn">íšŒì›íƒˆí‡´</button>
        </div>
    </section>
    <script>
        
        const API_BASE_URL = 'http://3.34.144.209:5000';
        document.addEventListener("DOMContentLoaded", loadUserInfo);

        // ë²„íŠ¼ ë™ì‘: ë©”ì¸í™”ë©´
        document.getElementById('header-title').addEventListener('click', () => {
            window.location.href = '/3_memo_list.html';
        });

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/my_info`, {
                    credentials: 'include', // ì„¸ì…˜ ì¿ í‚¤ í¬í•¨
                });
                if (!response.ok) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/2_login.html';
                    return;
                }

                const { email, nickname, img } = await response.json();

                // ì´ë©”ì¼ê³¼ ë‹‰ë„¤ì„ ì—…ë°ì´íŠ¸
                document.getElementById("user-email").textContent = email;
                document.getElementById("nickname").value = nickname;

                // ë“œë¡­ë‹¤ìš´ í”„ë¡œí•„ ì‚¬ì§„ ì—…ë°ì´íŠ¸
                const dropdownProfilePic = document.getElementById("dropdown-profile-pic");
                dropdownProfilePic.src = img ? `${API_BASE_URL}${img}` : 'default-profile.jpg';

                // í”„ë¡œí•„ ì‚¬ì§„ ì—…ë°ì´íŠ¸
                const profilePic = document.getElementById("profile-pic");
                if (img) {
                    profilePic.style.backgroundImage = `url(${API_BASE_URL}${img})`;
                } else {
                    profilePic.style.backgroundImage = 'none';
                }
            } catch (err) {
                console.error("ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
            }
        }

        // í”„ë¡œí•„ ì‚¬ì§„ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ ì°½ ì—´ê¸°
        document.getElementById("profile-pic").addEventListener("click", () => {
            document.getElementById("profile-pic-input").click();
        });
        // íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ ì´ë¦„ ë° ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        // íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ ë° íŒŒì¼ ì´ë¦„ í‘œì‹œ
        document.getElementById("profile-pic-input").addEventListener("change", (event) => {
            const file = event.target.files[0];
            const filename = file?.name || "ì„ íƒëœ íŒŒì¼ ì—†ìŒ";
            document.getElementById("profile-pic-filename").textContent = filename;

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById("profile-pic").style.backgroundImage = `url(${e.target.result})`;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById("update-btn").addEventListener("click", async () => {
            const nickname = document.getElementById("nickname").value;
            const profilePic = document.getElementById("profile-pic-input").files[0];
            const helperText = document.getElementById("helper-text");

            if (!nickname) {
                helperText.textContent = "*ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                return;
            }

            if (nickname.length > 10) {
                helperText.textContent = "* ë‹‰ë„¤ì„ì€ 10ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                return;
            }

            const formData = new FormData();
            formData.append("nickname", nickname);
            if (profilePic) {
                formData.append("img", profilePic);
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/my_info`, {
                    method: "PATCH",
                    body: formData,
                    credentials: 'include', // ì„¸ì…˜ ì¿ í‚¤ í¬í•¨
                });

                if (response.status === 400) {
                    const error = await response.json();
                    helperText.textContent = error.message || "ìˆ˜ì • ì‹¤íŒ¨";
                    return;
                }

                if (!response.ok) {
                    throw new Error("ì •ë³´ ìˆ˜ì • ì‹¤íŒ¨");
                }

                const { img } = await response.json(); // ì„œë²„ì—ì„œ ë°˜í™˜ëœ ì´ë¯¸ì§€ URL ì‚¬ìš©
                document.getElementById("profile-pic").style.backgroundImage = `url(${API_BASE_URL}/${img})`;

                alert("ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.reload(); // ìƒˆë¡œê³ ì¹¨
            } catch (err) {
                console.error("ì •ë³´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
            }
        });

        // ë¡œê·¸ì•„ì›ƒ
        document.getElementById("log_out_btn").addEventListener("click", () => {
            window.location.href = '/2_login.html';
        });

        document.getElementById("mod_pw_btn").addEventListener("click", () => {
            window.location.href = '/8_mod_pw.html';
        });

        // íšŒì›íƒˆí‡´
        // íšŒì›íƒˆí‡´ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById("delete-btn").addEventListener("click", async () => {
            if (!confirm("ì •ë§ íšŒì›íƒˆí‡´ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
                const response = await fetch(`${API_BASE_URL}/delete_user`, {
                    method: "DELETE",
                    credentials: "include", // ğŸ”¹ ì„¸ì…˜ ì¿ í‚¤ í¬í•¨ (ì¤‘ìš”)
                });

                if (response.status === 401) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                    window.location.href = '/2_login.html';
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "íšŒì›íƒˆí‡´ ì‹¤íŒ¨");
                }

                alert("íšŒì›íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = '/2_login.html'; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
            } catch (err) {
                console.error("íšŒì›íƒˆí‡´ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
                alert("íšŒì›íƒˆí‡´ ì‹¤íŒ¨: " + err.message);
            }
        });


    </script>
</body>
</html>
